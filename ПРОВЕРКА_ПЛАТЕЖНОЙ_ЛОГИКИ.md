# üö® –ü–û–õ–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ü–õ–ê–¢–ï–ñ–ù–û–ô –õ–û–ì–ò–ö–ò

## ‚úÖ –ß–¢–û –†–ê–ë–û–¢–ê–ï–¢ –ü–†–ê–í–ò–õ–¨–ù–û:

### 1. **–õ–æ–≥–∏–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —É—Ä–æ–∫–∞–º** (`/app/courses/level/[level]/page.tsx`)
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º isFree
if (level?.isFree) {
  setLoading(false);
  return; // –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —É—Ä–æ–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º
}

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ü–æ—Ç–æ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º user
if (!user) {
  router.push("/login");
  return; // –ü–ª–∞—Ç–Ω—ã–µ —É—Ä–æ–∫–∏ —Ç—Ä–µ–±—É—é—Ç –≤—Ö–æ–¥–∞
}

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ü–æ—Ç–æ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º hasPaid
if (!user.hasPaid) {
  router.push("/payment");
  return; // –ü–ª–∞—Ç–Ω—ã–µ —É—Ä–æ–∫–∏ —Ç—Ä–µ–±—É—é—Ç –æ–ø–ª–∞—Ç—ã
}

// ‚úÖ –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã - —É—Ä–æ–∫ –¥–æ—Å—Ç—É–ø–µ–Ω
setLoading(false);
```

**–í—ã–≤–æ–¥:** –õ–æ–≥–∏–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è - –ü–û–°–õ–ï –û–ü–õ–ê–¢–´ –í–°–ï –ü–õ–ê–¢–ù–´–ï –£–†–û–ö–ò –û–¢–ö–†–û–Æ–¢–°–Ø!

---

### 2. **Webhook –æ—Ç Stripe** (`/app/api/webhooks/stripe/route.ts`)
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º premium
case 'checkout.session.completed':
  await supabaseAdmin
    .from('profiles')
    .update({
      subscription_status: 'premium', // ‚Üê –≠–¢–û –ö–õ–Æ–ß–ï–í–û–ô –ú–û–ú–ï–ù–¢!
      subscription_end_date: subscriptionEndDate.toISOString(),
      stripe_customer_id: session.customer as string,
    })
    .eq('id', profile.id);
```

**–í—ã–≤–æ–¥:** –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã `subscription_status` = 'premium' ‚úÖ

---

### 3. **AuthContext** (`/contexts/AuthContext.tsx`)
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: hasPaid –∑–∞–≤–∏—Å–∏—Ç –æ—Ç subscription_status
hasPaid: profile.subscription_status === 'premium'
```

**–í—ã–≤–æ–¥:** –ï—Å–ª–∏ `subscription_status` = 'premium', —Ç–æ `hasPaid` = true ‚úÖ

---

### 4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫—É—Ä—Å–æ–≤** (`/app/courses/page.tsx`)
```typescript
const isLevelUnlocked = (levelId: number, isFree?: boolean) => {
  // ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —É—Ä–æ–∫–∏ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã
  if (isFree) return true;
  
  // ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ü–ª–∞—Ç–Ω—ã–µ —Ç—Ä–µ–±—É—é—Ç –≤—Ö–æ–¥–∞
  if (!user) return false;
  
  // ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ï—Å–ª–∏ –æ–ø–ª–∞—Ç–∏–ª - –í–°–ï –ø–ª–∞—Ç–Ω—ã–µ —É—Ä–æ–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
  if (user.hasPaid) return true;
  
  // ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ò–Ω–∞—á–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã
  return false;
};
```

**–í—ã–≤–æ–¥:** –õ–æ–≥–∏–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è - –ü–û–°–õ–ï –û–ü–õ–ê–¢–´ user.hasPaid = true, –í–°–ï –£–†–û–ö–ò –û–¢–ö–†–û–Æ–¢–°–Ø! ‚úÖ

---

## üö® –ù–ê–ô–î–ï–ù–´ –ü–†–û–ë–õ–ï–ú–´:

### ‚ùå –ü–†–û–ë–õ–ï–ú–ê ‚Ññ1: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –≤ reset subscription

**–§–∞–π–ª:** `/app/payment/page.tsx`, —Å—Ç—Ä–æ–∫–∞ 75-82

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
const { error } = await supabase
  .from('users')  // ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û! –¢–∞–±–ª–∏—Ü—ã 'users' –ù–ï–¢!
  .update({ 
    has_paid: false,
    stripe_customer_id: null,
    subscription_type: null
  })
  .eq('email', user?.email);
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```typescript
const { error } = await supabase
  .from('profiles')  // ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û!
  .update({ 
    subscription_status: 'free',  // ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û–ï –ü–û–õ–ï!
    stripe_customer_id: null,
    subscription_end_date: null
  })
  .eq('email', user?.email);
```

---

### ‚ùå –ü–†–û–ë–õ–ï–ú–ê ‚Ññ2: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

**–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Supabase:**

1. **–¢–∞–±–ª–∏—Ü–∞ `profiles` –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å –ø–æ–ª—è:**
   - `id` (UUID, primary key)
   - `email` (TEXT, unique)
   - `subscription_status` (TEXT, default 'free') ‚Üê **–í–ê–ñ–ù–û!**
   - `subscription_end_date` (TIMESTAMP)
   - `stripe_customer_id` (TEXT)
   - `created_at` (TIMESTAMP)
   - `updated_at` (TIMESTAMP)

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–µ—Ä–≤—ã–µ 3 —É—Ä–æ–∫–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ:**
```sql
SELECT id, title, is_free FROM courses WHERE id <= 10 ORDER BY id;

-- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
-- id=1: is_free = true  ‚úÖ
-- id=2: is_free = true  ‚úÖ
-- id=3: is_free = true  ‚úÖ
-- id=4: is_free = false ‚ùå
-- id=5: is_free = false ‚ùå
-- id=6: is_free = false ‚ùå
```

---

## üîÑ –ü–û–õ–ù–´–ô FLOW –û–ü–õ–ê–¢–´ (–ö–ê–ö –î–û–õ–ñ–ù–û –†–ê–ë–û–¢–ê–¢–¨):

### 1Ô∏è‚É£ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–û–ø–ª–∞—Ç–∏—Ç—å"
```
/payment ‚Üí handlePayment() ‚Üí /api/checkout
```

### 2Ô∏è‚É£ API —Å–æ–∑–¥–∞–µ—Ç Stripe Checkout Session
```
/api/checkout ‚Üí stripe.checkout.sessions.create()
‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç URL –Ω–∞ —Ñ–æ—Ä–º—É –æ–ø–ª–∞—Ç—ã Stripe
```

### 3Ô∏è‚É£ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç –Ω–∞ Stripe
```
–§–æ—Ä–º–∞ Stripe ‚Üí –í–≤–æ–¥ –∫–∞—Ä—Ç—ã ‚Üí –û–ø–ª–∞—Ç–∞
```

### 4Ô∏è‚É£ Stripe –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook
```
Stripe ‚Üí POST /api/webhooks/stripe
‚Üí event.type = 'checkout.session.completed'
```

### 5Ô∏è‚É£ Webhook –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å
```sql
UPDATE profiles 
SET subscription_status = 'premium',
    subscription_end_date = '2025-11-10',
    stripe_customer_id = 'cus_xxx'
WHERE id = 'user_id';
```

### 6Ô∏è‚É£ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ success
```
Stripe ‚Üí redirect ‚Üí /payment/success?session_id=xxx
```

### 7Ô∏è‚É£ Success —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å
```typescript
// –í AuthContext:
checkUser() ‚Üí 
  subscription_status === 'premium' ‚Üí
    hasPaid = true ‚úÖ
```

### 8Ô∏è‚É£ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —É—Ä–æ–∫
```typescript
// –í /courses/level/[level]/page.tsx:
if (!level?.isFree) {
  if (!user) redirect('/login')
  if (!user.hasPaid) redirect('/payment') ‚Üê –ù–ï –°–†–ê–ë–û–¢–ê–ï–¢, —Ç.–∫. hasPaid = true!
}
// ‚úÖ –£—Ä–æ–∫ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è!
```

---

## üìã –ß–ï–ö–õ–ò–°–¢ –î–õ–Ø –ü–†–û–í–ï–†–ö–ò:

### –ü–µ—Ä–µ–¥ –æ–ø–ª–∞—Ç–æ–π:
- [ ] –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
- [ ] –û—Ç–∫—Ä—ã—Ç—å —É—Ä–æ–∫ 1 ‚Üí ‚úÖ –î–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã—Ç—å—Å—è (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π)
- [ ] –û—Ç–∫—Ä—ã—Ç—å —É—Ä–æ–∫ 6 ‚Üí ‚ùå –î–æ–ª–∂–µ–Ω —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç—å –Ω–∞ /login

### –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ (–ë–ï–ó –æ–ø–ª–∞—Ç—ã):
- [ ] –í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç
- [ ] –û—Ç–∫—Ä—ã—Ç—å —É—Ä–æ–∫ 1 ‚Üí ‚úÖ –î–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã—Ç—å—Å—è
- [ ] –û—Ç–∫—Ä—ã—Ç—å —É—Ä–æ–∫ 6 ‚Üí ‚ùå –î–æ–ª–∂–µ–Ω —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç—å –Ω–∞ /payment
- [ ] –û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ ‚Üí –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏:
  ```
  üîç Lesson Access Check: {
    lessonId: 6,
    isFree: false,
    userLoggedIn: true,
    userHasPaid: false  ‚Üê –í–ê–ñ–ù–û!
  }
  ‚ùå Paid lesson - user has not paid, redirecting to /payment
  ```

### –°—Ä–∞–∑—É –ü–û–°–õ–ï –æ–ø–ª–∞—Ç—ã:
- [ ] –û–ø–ª–∞—Ç–∏—Ç—å –∫—É—Ä—Å ‚Üí –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ /payment/success
- [ ] –û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Å–æ–ª—å ‚Üí –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ user –æ–±–Ω–æ–≤–∏–ª—Å—è:
  ```javascript
  console.log(user.hasPaid); // –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å true
  console.log(user.subscription_status); // –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 'premium'
  ```
- [ ] –û—Ç–∫—Ä—ã—Ç—å —É—Ä–æ–∫ 4 ‚Üí ‚úÖ –î–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã—Ç—å—Å—è –ë–ï–ó —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞!
- [ ] –û—Ç–∫—Ä—ã—Ç—å —É—Ä–æ–∫ 6 ‚Üí ‚úÖ –î–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã—Ç—å—Å—è –ë–ï–ó —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞!
- [ ] –û—Ç–∫—Ä—ã—Ç—å —É—Ä–æ–∫ 100 ‚Üí ‚úÖ –î–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã—Ç—å—Å—è –ë–ï–ó —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞!

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ Supabase:
- [ ] –û—Ç–∫—Ä—ã—Ç—å Supabase ‚Üí Table Editor ‚Üí profiles
- [ ] –ù–∞–π—Ç–∏ —Å–≤–æ–π email
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—è:
  - `subscription_status` = 'premium' ‚úÖ
  - `subscription_end_date` = –±—É–¥—É—â–∞—è –¥–∞—Ç–∞ ‚úÖ
  - `stripe_customer_id` = 'cus_xxx' ‚úÖ

---

## üõ†Ô∏è –ß–¢–û –ù–£–ñ–ù–û –ò–°–ü–†–ê–í–ò–¢–¨:

### 1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é reset subscription
–í `/app/payment/page.tsx` –∑–∞–º–µ–Ω–∏—Ç—å `from('users')` –Ω–∞ `from('profiles')`

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã profiles
–£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –µ—Å—Ç—å –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è

### 3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å is_free —Ñ–ª–∞–≥–∏
–í—ã–ø–æ–ª–Ω–∏—Ç—å SQL –¥–ª—è —É—Ä–æ–∫–æ–≤ 1-3

---

## üí° –í–´–í–û–î–´:

1. ‚úÖ **–õ–æ–≥–∏–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø** - –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –í–°–ï —É—Ä–æ–∫–∏ –æ—Ç–∫—Ä–æ—é—Ç—Å—è
2. ‚úÖ **Webhook –ü–†–ê–í–ò–õ–¨–ù–´–ô** - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç subscription_status = 'premium'
3. ‚úÖ **AuthContext –ü–†–ê–í–ò–õ–¨–ù–´–ô** - hasPaid –∑–∞–≤–∏—Å–∏—Ç –æ—Ç subscription_status
4. ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞ —Ç–æ–ª—å–∫–æ –≤ reset subscription** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
5. ‚ùå **–í–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –≤ –±–∞–∑–µ** - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ is_free —Ñ–ª–∞–≥–∏

**–ü–û–°–õ–ï –û–ü–õ–ê–¢–´ –í–°–Å –î–û–õ–ñ–ù–û –†–ê–ë–û–¢–ê–¢–¨!** –ü—Ä–æ–±–ª–µ–º–∞ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –≤:
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Ñ–ª–∞–≥–∞—Ö is_free –≤ –±–∞–∑–µ
- –ò–ª–∏ –≤ –∫–µ—à–µ –±—Ä–∞—É–∑–µ—Ä–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã

---

## üîç –ö–ê–ö –û–¢–õ–ê–î–ò–¢–¨:

1. **–û—Ç–∫—Ä–æ–π –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)**
2. **–ü–æ—Å–º–æ—Ç—Ä–∏ –ª–æ–≥–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —É—Ä–æ–∫–∞:**
   ```
   üîç Lesson Access Check: {...}
   ```
3. **–ü—Ä–æ–≤–µ—Ä—å –∑–Ω–∞—á–µ–Ω–∏—è:**
   - `isFree` - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å false –¥–ª—è —É—Ä–æ–∫–æ–≤ 4+
   - `userHasPaid` - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å true –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
4. **–ï—Å–ª–∏ userHasPaid = false –ü–û–°–õ–ï –æ–ø–ª–∞—Ç—ã:**
   - –ü—Ä–æ–≤–µ—Ä—å Supabase ‚Üí profiles ‚Üí subscription_status
   - –ï—Å–ª–∏ subscription_status = 'free' ‚Üí webhook –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
   - –ï—Å–ª–∏ subscription_status = 'premium' ‚Üí –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É (Hard Refresh)

---

**–í–°–Å –î–û–õ–ñ–ù–û –†–ê–ë–û–¢–ê–¢–¨ –ü–û–°–õ–ï:**
1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è is_free —Ñ–ª–∞–≥–æ–≤ –≤ –±–∞–∑–µ (—É—Ä–æ–∫–∏ 1-3 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ)
2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è reset subscription —Ñ—É–Ω–∫—Ü–∏–∏
3. Hard Refresh –±—Ä–∞—É–∑–µ—Ä–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã (Cmd+Shift+R)
