# 🎨 СХЕМА РАБОТЫ СИСТЕМЫ 4 КУРСОВ

## 📊 **АРХИТЕКТУРА БАЗЫ ДАННЫХ**

```
┌─────────────────────────────────────────────────────┐
│  ТАБЛИЦА: course_categories                         │
├─────────────────────────────────────────────────────┤
│  id  | slug     | title             | total_lessons │
│  1   | websites | Сайты             | 12           │
│  2   | apps     | Приложения        | 5            │
│  3   | games    | Игры              | 8            │
│  4   | payments | Платёжные системы | 3            │
└─────────────────────────────────────────────────────┘
                          ↓
                   (связь 1 ко многим)
                          ↓
┌─────────────────────────────────────────────────────┐
│  ТАБЛИЦА: courses (уроки)                           │
├─────────────────────────────────────────────────────┤
│  id | title          | course_category_id | is_free│
│  1  | Первый HTML    | 1 (Сайты)         | true   │
│  2  | Стили CSS      | 1 (Сайты)         | true   │
│  3  | JavaScript     | 1 (Сайты)         | false  │
│  4  | React Native   | 2 (Приложения)    | true   │
│  5  | Игровой цикл   | 3 (Игры)          | true   │
└─────────────────────────────────────────────────────┘
```

---

## 🔄 **ПОТОК ДАННЫХ**

### **1. ПОЛЬЗОВАТЕЛЬ ЗАХОДИТ НА `/courses`:**

```
Браузер
   ↓
GET /courses
   ↓
┌──────────────────────────────┐
│  CourseSwitcher загружает:   │
│  GET /api/course-categories  │
└──────────────────────────────┘
   ↓
Показывает 4 карточки:
[🌐 Сайты] [📱 Приложения] [🎮 Игры] [💳 Платёжные системы]
   ↓
┌──────────────────────────────┐
│  Страница загружает:         │
│  GET /api/courses            │
└──────────────────────────────┘
   ↓
Показывает уроки первого курса (по умолчанию)
```

### **2. ПОЛЬЗОВАТЕЛЬ ПЕРЕКЛЮЧАЕТ КУРС:**

```
Клик на [📱 Приложения]
   ↓
onCategoryChange(category)
   ↓
Фильтрация:
allLevels.filter(level => 
  level.courseCategoryId === category.id
)
   ↓
Показывает только уроки "Приложения"
```

### **3. АДМИН ДОБАВЛЯЕТ УРОК В `/admin`:**

```
Заполнение формы:
- Название: "React Native"
- Описание: "Создаём мобильное приложение"
- Курс: 📱 Приложения (id=2)
- Бесплатный: ✅
   ↓
Нажатие "Сохранить"
   ↓
POST /api/courses
{
  title: "React Native",
  course_category_id: 2,
  is_free: true,
  ...
}
   ↓
Supabase INSERT INTO courses
   ↓
🔔 ТРИГГЕР: update_lesson_count_trigger
   ↓
UPDATE course_categories
SET total_lessons = (
  SELECT COUNT(*) FROM courses
  WHERE course_category_id = 2
)
WHERE id = 2
   ↓
✅ Счётчик обновлён автоматически!
```

---

## 🎨 **ВИЗУАЛИЗАЦИЯ СТРАНИЦЫ `/courses`**

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃              ВЫБЕРИ КУРС 🎓                        ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐
│ 🌐 Сайты   │  │📱Приложения│  │  🎮 Игры   │  │ 💳 Платежи │
│            │  │            │  │            │  │            │
│ 12 уроков  │  │  5 уроков  │  │  8 уроков  │  │  3 урока   │
│   [ВЫБРАН] │  │            │  │            │  │            │
└────────────┘  └────────────┘  └────────────┘  └────────────┘
     ↓ активный
     
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         УРОКИ КУРСА "САЙТЫ" (12 уроков)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

       ╭─────╮
    1  │  ✓  │  Первый HTML          [бесплатный]
       ╰─────╯
            ╲
             ╲
          ╭─────╮
       2  │  ✓  │  Стили CSS           [бесплатный]
          ╰─────╯
               ╲
                ╲
             ╭─────╮
          3  │  🔒 │  JavaScript        [платный]
             ╰─────╯
                  ╲
                   ╲
                ╭─────╮
             4  │  🔒 │  React основы    [платный]
                ╰─────╯

          ... ещё 8 уроков ...
```

---

## 🛠️ **КОМПОНЕНТЫ СИСТЕМЫ**

### **Frontend (React):**

```
app/courses/page.tsx
├─ CourseSwitcher          → Переключатель курсов
├─ allLevels.filter()      → Фильтрация уроков
└─ Урок-карточки           → Отображение уроков
```

### **Backend (Next.js API):**

```
app/api/course-categories/route.ts
├─ GET  → Получить все категории
└─ PUT  → Обновить статистику

app/api/courses/route.ts
├─ GET    → Получить все уроки
├─ POST   → Создать урок
├─ PUT    → Обновить урок
└─ DELETE → Удалить урок
```

### **Database (Supabase):**

```
course_categories
├─ id, slug, title, icon, color
├─ total_lessons (автообновляется)
└─ display_order

courses
├─ id, title, description
├─ course_category_id (FK)
├─ is_free
└─ display_order

TRIGGER: update_lesson_count_trigger
└─ Автоматически обновляет total_lessons
```

---

## 🔐 **ЛОГИКА ДОСТУПА К УРОКАМ**

```
Пользователь НЕ авторизован:
├─ Урок 1 (is_free=true)   → ✅ ОТКРЫТ
└─ Урок 2+ (любые)          → 🔒 ЗАКРЫТ

Пользователь авторизован БЕЗ подписки:
├─ Урок 1 (is_free=true)   → ✅ ОТКРЫТ
├─ Урок 2 (is_free=true)   → ✅ ОТКРЫТ (если урок 1 пройден)
└─ Урок N (is_free=false)  → 🔒 ЗАКРЫТ (требует оплату)

Пользователь С ПОДПИСКОЙ:
├─ Урок 1                   → ✅ ОТКРЫТ
├─ Урок 2                   → ✅ ОТКРЫТ (если урок 1 пройден)
└─ Урок N                   → ✅ ОТКРЫТ (если урок N-1 пройден)
```

---

## 🎯 **РЕКОМЕНДУЕМАЯ СТРУКТУРА КУРСОВ**

### **🌐 Курс "Сайты" (12-15 уроков):**
```
✅ 1. Первый HTML (бесплатный)
✅ 2. Стили CSS (бесплатный)
🔒 3. JavaScript основы (платный)
🔒 4. React компоненты (платный)
🔒 5. Next.js роутинг (платный)
🔒 6-12. Продвинутые темы (платные)
```

### **📱 Курс "Приложения" (8-10 уроков):**
```
✅ 1. Первое приложение (бесплатный)
🔒 2. React Native (платный)
🔒 3-10. Продвинутые темы (платные)
```

### **🎮 Курс "Игры" (10-12 уроков):**
```
✅ 1. Первая игра (бесплатный)
🔒 2. Игровой цикл (платный)
🔒 3-12. Продвинутые темы (платные)
```

### **💳 Курс "Платёжные системы" (5-7 уроков):**
```
✅ 1. Введение в платежи (бесплатный)
🔒 2. Stripe интеграция (платный)
🔒 3-7. Продвинутые темы (платные)
```

---

## 📈 **МЕТРИКИ И АНАЛИТИКА**

### **Отслеживаем:**
```sql
-- Популярность курсов
SELECT 
  cc.title,
  COUNT(up.id) as completions
FROM course_categories cc
LEFT JOIN courses c ON c.course_category_id = cc.id
LEFT JOIN user_progress up ON up.course_slug = c.slug
GROUP BY cc.id
ORDER BY completions DESC;

-- Конверсия в оплату
SELECT 
  COUNT(DISTINCT user_id) as free_users,
  COUNT(DISTINCT CASE WHEN has_paid THEN user_id END) as paid_users
FROM profiles;
```

---

## 🚀 **ОПТИМИЗАЦИЯ ПРОИЗВОДИТЕЛЬНОСТИ**

### **Кэширование:**
```typescript
// Категории курсов кэшируются в state
const [categories, setCategories] = useState<CourseCategory[]>([]);

// Загружаются один раз при mount
useEffect(() => {
  loadCategories();
}, []);
```

### **Фильтрация на клиенте:**
```typescript
// Вместо запросов к API при каждом переключении
// фильтруем уже загруженные уроки
allLevels.filter(level => 
  level.courseCategoryId === activeCategory.id
)
```

---

## ✅ **ЧЕКЛИСТ ГОТОВНОСТИ**

- [ ] База данных настроена (CLEAR_ALL_AND_SETUP.sql)
- [ ] 4 курса созданы (Сайты, Приложения, Игры, Платежи)
- [ ] Триггер автосчётчика работает
- [ ] Переключатель курсов на `/courses` работает
- [ ] Селектор курса в `/admin` работает
- [ ] Добавлено минимум 3 урока в каждый курс
- [ ] Первые 1-2 урока помечены бесплатными
- [ ] Тестирование: гость видит 1 урок
- [ ] Тестирование: залогиненный видит 2 урока
- [ ] Тестирование: с подпиской видит все уроки

---

## 🎉 **СИСТЕМА ГОТОВА К РАБОТЕ!**

Все компоненты связаны и работают автоматически:
- ✅ Переключатель курсов
- ✅ Фильтрация уроков
- ✅ Автосчётчик
- ✅ Админка
- ✅ Бесплатные/платные

**НАЧИНАЙ ДОБАВЛЯТЬ КОНТЕНТ!** 🚀
